<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>CarND Project 3:  Behavioral Cloning</title>
<!-- 2017-01-19 Thu 10:54 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="David A. Ventimiglia" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<style>body {font-size:large; max-width:50em}</style>
<style>pre.src {background-color: #2B2B2B; color: #a9b7c6; margin: 0; overflow-x: scroll;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">CarND Project 3:  Behavioral Cloning</h1>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> What</h2>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Why</h2>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> How</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Approach</h3>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Data</h3>
<div class="outline-text-3" id="text-3-2">
</div><div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> Collection and Preparation</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
Get the simulators.
</p>

<div class="org-src-container">

<pre class="src src-sh">wget -O simulator-linux.zip <span style="color: #e9b96e;">"https://d17h27t6h515a5.cloudfront.net/topher/2016/November/5831f0f7_simulator-linux/simulator-linux.zip"</span>
wget -O simulator-beta.zip <span style="color: #e9b96e;">"https://d17h27t6h515a5.cloudfront.net/topher/2017/January/587527cb_udacity-sdc-udacity-self-driving-car-simulator-dominique-development-linux-desktop-64-bit-5/udacity-sdc-udacity-self-driving-car-simulator-dominique-development-linux-desktop-64-bit-5.zip"</span>
unzip -d simulator-linux -u simulator-linux.zip &gt; /dev/null 2&gt;&amp;1
unzip -d simulator-beta -u simulator-beta.zip &gt; /dev/null 2&gt;&amp;1
</pre>
</div>

<p>
Get the data, shuffle it, and separate it into training and evaluation sets.
</p>

<div class="org-src-container">

<pre class="src src-sh">wget -nc <span style="color: #e9b96e;">"https://d17h27t6h515a5.cloudfront.net/topher/2016/December/584f6edd_data/data.zip"</span>
unzip data.zip &gt; /dev/null 2&gt;&amp;1
rm -rf __MACOSX

cat data/driving_log.csv | tail -n+2 | shuf &gt; data/driving_log_all.csv
cat data/driving_log_all.csv | head -n7000 &gt; data/driving_log_train.csv
cat data/driving_log_all.csv | tail -n+7000 &gt; data/driving_log_validation.csv
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">wc -l data/driving_log_all.csv
wc -l data/driving_log_train.csv
wc -l data/driving_log_validation.csv
</pre>
</div>

<pre class="example">
8036 data/driving_log_all.csv
7000 data/driving_log_train.csv
1037 data/driving_log_validation.csv
</pre>
</div>
</div>

<div id="outline-container-sec-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> Setup</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
Create the Conda environment.
</p>

<div class="org-src-container">

<pre class="src src-sh">conda env create --file environment.yml --name CarND-Behavioral-Cloning
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-2-3" class="outline-4">
<h4 id="sec-3-2-3"><span class="section-number-4">3.2.3</span> Utilities</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
Return elements from the iterable.  Shuffle the elements of the
iterable when it becomes exhausted, then begin returning them
again.  Repeat this sequence of operations indefinitely.  Note
that the elements of the iterable are essentially returned in
batches, and that the first batch is not shuffled.  If you want
only to return random elements then you must know batch size,
which will be the number of elements in the underlying finite
iterable, and you must discard the first batch.  The
itertools.islice function can be helpful here.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #b4fa70;">from</span> PIL <span style="color: #b4fa70;">import</span> Image
<span style="color: #b4fa70;">from</span> itertools <span style="color: #b4fa70;">import</span> groupby, islice, zip_longest, cycle, filterfalse
<span style="color: #b4fa70;">from</span> scipy.stats <span style="color: #b4fa70;">import</span> kurtosis, skew, describe
<span style="color: #b4fa70;">import</span> keras.preprocessing.image <span style="color: #b4fa70;">as</span> img
<span style="color: #b4fa70;">import</span> matplotlib.pyplot <span style="color: #b4fa70;">as</span> plt
<span style="color: #b4fa70;">import</span> numpy <span style="color: #b4fa70;">as</span> np
<span style="color: #b4fa70;">import</span> random
<span style="color: #b4fa70;">import</span> sys
</pre>
</div>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #b4fa70;">def</span> <span style="color: #fce94f;">rcycle</span>(iterable):
    <span style="color: #fcaf3e;">saved</span> = []
    <span style="color: #b4fa70;">for</span> element <span style="color: #b4fa70;">in</span> iterable:
        <span style="color: #b4fa70;">yield</span> element
        saved.append(element)
    <span style="color: #b4fa70;">while</span> saved:
        random.shuffle(saved)
        <span style="color: #b4fa70;">for</span> element <span style="color: #b4fa70;">in</span> saved:
              <span style="color: #b4fa70;">yield</span> element
</pre>
</div>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #fcaf3e;">feed</span> = <span style="color: #b4fa70;">lambda</span> filename: (l <span style="color: #b4fa70;">for</span> l <span style="color: #b4fa70;">in</span> <span style="color: #e090d7;">open</span>(filename))
<span style="color: #fcaf3e;">split</span> = <span style="color: #b4fa70;">lambda</span> <span style="color: #fcaf3e;">lines</span>, <span style="color: #fcaf3e;">delimiter</span>=<span style="color: #e9b96e;">","</span>: (line.split(delimiter) <span style="color: #b4fa70;">for</span> line <span style="color: #b4fa70;">in</span> lines)
<span style="color: #fcaf3e;">select</span> = <span style="color: #b4fa70;">lambda</span> fields, indices: ([r[i] <span style="color: #b4fa70;">for</span> i <span style="color: #b4fa70;">in</span> indices] <span style="color: #b4fa70;">for</span> r <span style="color: #b4fa70;">in</span> fields)
<span style="color: #fcaf3e;">load</span> = <span style="color: #b4fa70;">lambda</span> f: np.asarray(Image.<span style="color: #e090d7;">open</span>(f))
<span style="color: #fcaf3e;">fetch</span> = <span style="color: #b4fa70;">lambda</span> records, base: ([load(base+f.strip()) <span style="color: #b4fa70;">for</span> f <span style="color: #b4fa70;">in</span> record[:1]]+[<span style="color: #e090d7;">float</span>(v) <span style="color: #b4fa70;">for</span> v <span style="color: #b4fa70;">in</span> record[1:]] <span style="color: #b4fa70;">for</span> record <span style="color: #b4fa70;">in</span> records)
<span style="color: #fcaf3e;">rshift</span> = <span style="color: #b4fa70;">lambda</span> <span style="color: #fcaf3e;">x</span>, <span style="color: #fcaf3e;">factor</span>=0.1: img.random_shift(x, factor, 0.0, 0, 1, 2, fill_mode=<span style="color: #e9b96e;">'wrap'</span>)
<span style="color: #fcaf3e;">group</span> = <span style="color: #b4fa70;">lambda</span> <span style="color: #fcaf3e;">items</span>, <span style="color: #fcaf3e;">n</span>, <span style="color: #fcaf3e;">fillvalue</span>=<span style="color: #e9b2e3;">None</span>: zip_longest(*([<span style="color: #e090d7;">iter</span>(items)]*n), fillvalue=fillvalue)
<span style="color: #fcaf3e;">transpose</span> = <span style="color: #b4fa70;">lambda</span> tuples: (<span style="color: #e090d7;">list</span>(<span style="color: #e090d7;">map</span>(<span style="color: #e090d7;">list</span>, <span style="color: #e090d7;">zip</span>(*g))) <span style="color: #b4fa70;">for</span> g <span style="color: #b4fa70;">in</span> tuples)
<span style="color: #fcaf3e;">batch</span> = <span style="color: #b4fa70;">lambda</span> <span style="color: #fcaf3e;">groups</span>, <span style="color: #fcaf3e;">indices</span>=[0, 1]: ([np.asarray(t[i]) <span style="color: #b4fa70;">for</span> i <span style="color: #b4fa70;">in</span> indices] <span style="color: #b4fa70;">for</span> t <span style="color: #b4fa70;">in</span> groups)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-2-4" class="outline-4">
<h4 id="sec-3-2-4"><span class="section-number-4">3.2.4</span> Exploratory Analysis</h4>
<div class="outline-text-4" id="text-3-2-4">
<p>
Get the target labels&#x2014;the steering angles&#x2014;for <i>all</i> of the
data, from <code>data/driving_log_all.csv</code>, plot a histogram, and
generate basic descriptive statistics.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #fcaf3e;">f</span> = plt.figure()
<span style="color: #fcaf3e;">y1</span> = np.array([<span style="color: #e090d7;">float</span>(s[0]) <span style="color: #b4fa70;">for</span> s <span style="color: #b4fa70;">in</span> select(split(feed(<span style="color: #e9b96e;">"data/driving_log_all.csv"</span>)),[3])])
<span style="color: #fcaf3e;">h</span> = plt.hist(y1,bins=100)
<span style="color: #fcaf3e;">s</span> = plt.savefig(<span style="color: #e9b96e;">"hist1.png"</span>, <span style="color: #e090d7;">format</span>=<span style="color: #e9b96e;">'png'</span>)
describe(y1)
</pre>
</div>

<pre class="example">
DescribeResult(nobs=8036, minmax=(-0.94269539999999996, 1.0), mean=0.0040696440648332515, variance=0.016599764281272529, skewness=-0.13028924577521922, kurtosis=6.311554102057668)
</pre>


<div class="figure">
<p><img src="hist1.png" alt="CarND/Architecture Image" title="Architecture" />
</p>
<p><span class="figure-number">Figure 1:</span> All Samples - No Reflection</p>
</div>

<p>
The data have non-zero <i>mean</i> and <i>skewness</i>.  perhaps arising
from a bias toward left-hand turns when driving on a closed
track.
</p>

<ul class="org-ul">
<li>mean=0.0040696440648332515
</li>
<li>skewness=-0.13028924577521922
</li>
</ul>

<p>
The data are dominated by small steering angles because the car
spends most of its time on the track in straightaways.  The
asymmetry in the data is more apparent if we mask out small
angles and repeat the analysis.  Steering angles occupy the
interval [-1, 1], but the "straight" samples appear to be within
the neighborhood [-0.01, 0.01].
</p>

<p>
We might consider masking out small angled samples from the
actual training data as well, a subject we shall return to in a
later section.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #fcaf3e;">f</span> = plt.figure()
<span style="color: #fcaf3e;">p</span> = <span style="color: #b4fa70;">lambda</span> x: <span style="color: #e090d7;">abs</span>(x)&lt;0.01
<span style="color: #fcaf3e;">y2</span> = np.array([s <span style="color: #b4fa70;">for</span> s <span style="color: #b4fa70;">in</span> filterfalse(p,y1)])
<span style="color: #fcaf3e;">h</span> = plt.hist(y2,bins=100)
<span style="color: #fcaf3e;">s</span> = plt.savefig(<span style="color: #e9b96e;">"hist2.png"</span>, <span style="color: #e090d7;">format</span>=<span style="color: #e9b96e;">'png'</span>)
describe(y2)
</pre>
</div>

<pre class="example">
DescribeResult(nobs=3584, minmax=(-0.94269539999999996, 1.0), mean=0.0091718659514508933, variance=0.037178302717086116, skewness=-0.16657825969015194, kurtosis=1.1768785967587378)
</pre>


<div class="figure">
<p><img src="hist2.png" alt="CarND/Architecture Image" title="Architecture" />
</p>
<p><span class="figure-number">Figure 2:</span> abs(angle)&gt;0.01 - No Reflection</p>
</div>

<p>
A simple trick that we can play to remove this asymmetry&#x2014;if we
wish&#x2014;is to join the data with its reflection, effectively
doubling our sample size in the process.  For illustration
purposes only, we shall again mask out small angle samples.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #fcaf3e;">f</span> = plt.figure()
<span style="color: #fcaf3e;">y3</span> = np.append(y2, -y2)
<span style="color: #fcaf3e;">h</span> = plt.hist(y3,bins=100)
<span style="color: #fcaf3e;">s</span> = plt.savefig(<span style="color: #e9b96e;">"hist3.png"</span>, <span style="color: #e090d7;">format</span>=<span style="color: #e9b96e;">'png'</span>)
describe(y3)
</pre>
</div>

<pre class="example">
DescribeResult(nobs=7168, minmax=(-1.0, 1.0), mean=0.0, variance=0.03725725015081123, skewness=0.0, kurtosis=1.1400026599654973)
</pre>


<div class="figure">
<p><img src="hist3.png" alt="CarND/Architecture Image" title="Architecture" />
</p>
<p><span class="figure-number">Figure 3:</span> abs(angle)&gt;0.01 - Full Reflection</p>
</div>

<p>
In one of the least-surprising outcomes of the year, after
performing the reflection and joining operations, the data now
are symmetrical.
</p>

<ul class="org-ul">
<li>mean=0.0
</li>
<li>skewness=0.0
</li>
</ul>

<p>
Of course, in this analysis we have only reflected the target
labels.  If we apply this strategy to the training data,
naturally we need to reflect along their horizontal axes the
corresponding input images as well.
</p>
</div>
</div>

<div id="outline-container-sec-3-2-5" class="outline-4">
<h4 id="sec-3-2-5"><span class="section-number-4">3.2.5</span> Examples</h4>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Implementation</h3>
<div class="outline-text-3" id="text-3-3">
</div><div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> Model</h4>
<div class="outline-text-4" id="text-3-3-1">
<dl class="org-dl">
<dt> Crop </dt><dd>crop to region (<i>non-trainable</i>)
</dd>
<dt> Resize </dt><dd>reduce scale (<i>non-trainable</i>)
</dd>
<dt> Normalize </dt><dd>scale values to [-1, 1] (<i>non-trainable</i>)
</dd>
<dt> Convolution </dt><dd>learn spatial features and compress
</dd>
<dt> MaxPool </dt><dd>reduce model size
</dd>
<dt> Dropout </dt><dd>add regularization (<i>non-trainable</i>)
</dd>
<dt> Flatten </dt><dd>stage to fully-connected layers (<i>non-trainable</i>)
</dd>
<dt> FC </dt><dd>fully-connected layers
</dd>
<dt> Readout </dt><dd>single node steering angle (<i>non-trainable</i>)
</dd>
</dl>

<p>
Return a Keras neural network model.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #b4fa70;">from</span> keras.layers <span style="color: #b4fa70;">import</span> Conv2D, Flatten, MaxPooling2D, Dense, Dropout, Lambda, AveragePooling2D
<span style="color: #b4fa70;">from</span> keras.layers.convolutional <span style="color: #b4fa70;">import</span> Cropping2D, Convolution2D
<span style="color: #b4fa70;">from</span> keras.models <span style="color: #b4fa70;">import</span> Sequential, model_from_json
<span style="color: #b4fa70;">from</span> keras.utils.visualize_util <span style="color: #b4fa70;">import</span> plot

<span style="color: #b4fa70;">def</span> <span style="color: #fce94f;">CarND</span>(input_shape):
    <span style="color: #fcaf3e;">model</span> = Sequential()

    <span style="color: #73d216;"># </span><span style="color: #73d216;">Crop</span>
    model.add(Cropping2D(((80,20),(1,1)), input_shape=input_shape, name=<span style="color: #e9b96e;">"Crop"</span>))

    <span style="color: #73d216;"># </span><span style="color: #73d216;">Resize</span>
    model.add(AveragePooling2D(pool_size=(1,4), name=<span style="color: #e9b96e;">"Resize"</span>, trainable=<span style="color: #e9b2e3;">False</span>))

    <span style="color: #73d216;"># </span><span style="color: #73d216;">Normalize input.</span>
    model.add(Lambda(<span style="color: #b4fa70;">lambda</span> x: x/127.5 - 1., name=<span style="color: #e9b96e;">"Normalize"</span>))

    <span style="color: #73d216;"># </span><span style="color: #73d216;">Reduce dimensions through trainable convolution, activation, and</span>
    <span style="color: #73d216;"># </span><span style="color: #73d216;">pooling layers.</span>
    model.add(Convolution2D(24, 3, 3, subsample=(2,2), name=<span style="color: #e9b96e;">"Convolution2D1"</span>, activation=<span style="color: #e9b96e;">"relu"</span>))
    model.add(MaxPooling2D(name=<span style="color: #e9b96e;">"MaxPool1"</span>))
    model.add(Convolution2D(36, 3, 3, subsample=(1,1), name=<span style="color: #e9b96e;">"Convolution2D2"</span>, activation=<span style="color: #e9b96e;">"relu"</span>))
    model.add(MaxPooling2D(name=<span style="color: #e9b96e;">"MaxPool2"</span>))
    model.add(Convolution2D(48, 3, 3, subsample=(1,1), name=<span style="color: #e9b96e;">"Convolution2D3"</span>, activation=<span style="color: #e9b96e;">"relu"</span>))
    model.add(MaxPooling2D(name=<span style="color: #e9b96e;">"MaxPool3"</span>))

    <span style="color: #73d216;"># </span><span style="color: #73d216;">Dropout for regularization</span>
    model.add(Dropout(0.1, name=<span style="color: #e9b96e;">"Dropout"</span>))

    <span style="color: #73d216;"># </span><span style="color: #73d216;">Flatten input in a non-trainable layer before feeding into</span>
    <span style="color: #73d216;"># </span><span style="color: #73d216;">fully-connected layers.</span>
    model.add(Flatten(name=<span style="color: #e9b96e;">"Flatten"</span>))

    <span style="color: #73d216;"># </span><span style="color: #73d216;">Model steering through trainable layers comprising dense units</span>
    <span style="color: #73d216;"># </span><span style="color: #73d216;">as ell as dropout units for regularization.</span>
    model.add(Dense(100, activation=<span style="color: #e9b96e;">"relu"</span>, name=<span style="color: #e9b96e;">"FC2"</span>))
    model.add(Dense(50, activation=<span style="color: #e9b96e;">"relu"</span>, name=<span style="color: #e9b96e;">"FC3"</span>))
    model.add(Dense(10, activation=<span style="color: #e9b96e;">"relu"</span>, name=<span style="color: #e9b96e;">"FC4"</span>))

    <span style="color: #73d216;"># </span><span style="color: #73d216;">Generate output (steering angles) with a single non-trainable</span>
    <span style="color: #73d216;"># </span><span style="color: #73d216;">node.</span>
    model.add(Dense(1, name=<span style="color: #e9b96e;">"Readout"</span>, trainable=<span style="color: #e9b2e3;">False</span>))
    <span style="color: #b4fa70;">return</span> model
</pre>
</div>

<div class="org-src-container">

<pre class="src src-python">CarND([160, 320, 3]).summary()
</pre>
</div>

<pre class="example">
____________________________________________________________________________________________________
Layer (type)                     Output Shape          Param #     Connected to                     
====================================================================================================
Crop (Cropping2D)                (None, 60, 318, 3)    0           cropping2d_input_5[0][0]         
____________________________________________________________________________________________________
Resize (AveragePooling2D)        (None, 60, 79, 3)     0           Crop[0][0]                       
____________________________________________________________________________________________________
Normalize (Lambda)               (None, 60, 79, 3)     0           Resize[0][0]                     
____________________________________________________________________________________________________
Convolution2D1 (Convolution2D)   (None, 29, 39, 24)    672         Normalize[0][0]                  
____________________________________________________________________________________________________
MaxPool1 (MaxPooling2D)          (None, 14, 19, 24)    0           Convolution2D1[0][0]             
____________________________________________________________________________________________________
Convolution2D2 (Convolution2D)   (None, 12, 17, 36)    7812        MaxPool1[0][0]                   
____________________________________________________________________________________________________
MaxPool2 (MaxPooling2D)          (None, 6, 8, 36)      0           Convolution2D2[0][0]             
____________________________________________________________________________________________________
Convolution2D3 (Convolution2D)   (None, 4, 6, 48)      15600       MaxPool2[0][0]                   
____________________________________________________________________________________________________
MaxPool3 (MaxPooling2D)          (None, 2, 3, 48)      0           Convolution2D3[0][0]             
____________________________________________________________________________________________________
Dropout (Dropout)                (None, 2, 3, 48)      0           MaxPool3[0][0]                   
____________________________________________________________________________________________________
Flatten (Flatten)                (None, 288)           0           Dropout[0][0]                    
____________________________________________________________________________________________________
FC2 (Dense)                      (None, 100)           28900       Flatten[0][0]                    
____________________________________________________________________________________________________
FC3 (Dense)                      (None, 50)            5050        FC2[0][0]                        
____________________________________________________________________________________________________
FC4 (Dense)                      (None, 10)            510         FC3[0][0]                        
____________________________________________________________________________________________________
Readout (Dense)                  (None, 1)             0           FC4[0][0]                        
====================================================================================================
Total params: 58,544
Trainable params: 58,544
Non-trainable params: 0
____________________________________________________________________________________________________
</pre>

<div class="org-src-container">

<pre class="src src-python">plot(CarND([160, 320, 3]), to_file=<span style="color: #e9b96e;">"model.png"</span>, show_shapes=<span style="color: #e9b2e3;">True</span>)
</pre>
</div>


<div class="figure">
<p><img src="model.png" alt="CarND/Architecture Image" title="Architecture" />
</p>
<p><span class="figure-number">Figure 4:</span> CarND Neural-Net Architecture</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Training</h3>
<div class="outline-text-3" id="text-3-4">
</div><div id="outline-container-sec-3-4-1" class="outline-4">
<h4 id="sec-3-4-1"><span class="section-number-4">3.4.1</span> Data Pipeline</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
Create a data-processing pipeline.  The 'trainingfile'
parameter is the name of a CSV index file specifying samples,
with fields for image filenames and for steering angles.  The
'base<sub>path'</sub> parameter is the directory path for the image
filenames.  The pipeline itself is a generator (which is an
iterable), where each item from the generator is a batch of
samples (X,y).  X and y are each NumPy arrays, with X as a batch
of images and y as a batch of outputs.  Finally, augmentation
may be performed if a training pipeline is desired, determined
by the 'training' parameter.  Training pipelines have their
images randomly flipped along the horizontal axis, and are
randomly shifted along their horizontal axis.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #b4fa70;">def</span> <span style="color: #fce94f;">pipeline</span>(theta, training=<span style="color: #e9b2e3;">False</span>):
    <span style="color: #fcaf3e;">samples</span> = select(rcycle(fetch(select(split(feed(theta.trainingfile)), [0,3]), theta.base_path)), [0,1])
    <span style="color: #b4fa70;">if</span> training:
        <span style="color: #b4fa70;">if</span> theta.flip:
            <span style="color: #fcaf3e;">samples</span> = (rflip(x) <span style="color: #b4fa70;">for</span> x <span style="color: #b4fa70;">in</span> samples)
        <span style="color: #b4fa70;">if</span> theta.shift:
            <span style="color: #fcaf3e;">samples</span> = (rflip(x) <span style="color: #b4fa70;">for</span> x <span style="color: #b4fa70;">in</span> samples)
    <span style="color: #fcaf3e;">groups</span> = group(samples, theta.batch_size)
    <span style="color: #fcaf3e;">batches</span> = batch(transpose(groups))
    <span style="color: #b4fa70;">return</span> batches
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-4-2" class="outline-4">
<h4 id="sec-3-4-2"><span class="section-number-4">3.4.2</span> Training</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
Essentially a struct just to gather hyper-parameters into one
place, for convenience.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #b4fa70;">class</span> <span style="color: #8cc4ff;">HyperParameters</span>:
    <span style="color: #b4fa70;">def</span> <span style="color: #fce94f;">__init__</span>(<span style="color: #b4fa70;">self</span>):
        <span style="color: #b4fa70;">return</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #fcaf3e;">theta</span> = HyperParameters()
<span style="color: #fcaf3e;">theta.input_shape</span> = [160, 320, 3]
<span style="color: #fcaf3e;">theta.samples_per_epoch</span> = 30
<span style="color: #fcaf3e;">theta.valid_samples_per_epoch</span> = 30
<span style="color: #fcaf3e;">theta.epochs</span> = 3
<span style="color: #fcaf3e;">theta.batch_size</span> = 10
<span style="color: #fcaf3e;">theta.trainingfile</span> = <span style="color: #e9b96e;">"data/driving_log_overtrain.csv"</span>
<span style="color: #fcaf3e;">theta.validationfile</span> = <span style="color: #e9b96e;">"data/driving_log_overtrain.csv"</span>
<span style="color: #fcaf3e;">theta.base_path</span> = <span style="color: #e9b96e;">"data/"</span>
<span style="color: #fcaf3e;">theta.flip</span> = <span style="color: #e9b2e3;">False</span>
<span style="color: #fcaf3e;">theta.shift</span> = <span style="color: #e9b2e3;">False</span>
<span style="color: #fcaf3e;">model</span> = CarND(theta.input_shape)
model.<span style="color: #e090d7;">compile</span>(loss=<span style="color: #e9b96e;">"mse"</span>, optimizer=<span style="color: #e9b96e;">"adam"</span>)
<span style="color: #fcaf3e;">traingen</span> = pipeline(theta, training=<span style="color: #e9b2e3;">True</span>)
<span style="color: #fcaf3e;">validgen</span> = pipeline(theta)
<span style="color: #b4fa70;">print</span>(<span style="color: #e9b96e;">""</span>)
<span style="color: #fcaf3e;">history</span> = model.fit_generator(
    traingen,
    theta.samples_per_epoch,
    theta.epochs,
    validation_data=validgen,
    verbose=2,
    nb_val_samples=theta.valid_samples_per_epoch)
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt;
... ... ... ... ... ... Epoch 1/3
1s - loss: 0.6218 - val_loss: 0.5903
Epoch 2/3
0s - loss: 0.5571 - val_loss: 0.4627
Epoch 3/3
0s - loss: 0.3969 - val_loss: 0.2196
</pre>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #fcaf3e;">theta</span> = HyperParameters()
<span style="color: #fcaf3e;">theta.input_shape</span> = [160, 320, 3]
<span style="color: #fcaf3e;">theta.trainingfile</span> = <span style="color: #e9b96e;">"data/driving_log_train.csv"</span>
<span style="color: #fcaf3e;">theta.validationfile</span> = <span style="color: #e9b96e;">"data/driving_log_validation.csv"</span>
<span style="color: #fcaf3e;">theta.base_path</span> = <span style="color: #e9b96e;">"data/"</span>
<span style="color: #fcaf3e;">theta.samples_per_epoch</span> = 7000
<span style="color: #fcaf3e;">theta.valid_samples_per_epoch</span> = 7000
<span style="color: #fcaf3e;">theta.epochs</span> = 5
<span style="color: #fcaf3e;">theta.batch_size</span> = 100
<span style="color: #fcaf3e;">theta.flip</span> = <span style="color: #e9b2e3;">False</span>
<span style="color: #fcaf3e;">theta.shift</span> = <span style="color: #e9b2e3;">False</span>
<span style="color: #fcaf3e;">model</span> = CarND(theta.input_shape)
model.<span style="color: #e090d7;">compile</span>(loss=<span style="color: #e9b96e;">"mse"</span>, optimizer=<span style="color: #e9b96e;">"adam"</span>)
<span style="color: #b4fa70;">print</span>(<span style="color: #e9b96e;">""</span>)
<span style="color: #73d216;"># </span><span style="color: #73d216;">history = model.fit_generator(</span>
<span style="color: #73d216;">#           </span><span style="color: #73d216;">traingen,</span>
<span style="color: #73d216;">#           </span><span style="color: #73d216;">theta.samples_per_epoch,</span>
<span style="color: #73d216;">#           </span><span style="color: #73d216;">theta.epochs,</span>
<span style="color: #73d216;">#           </span><span style="color: #73d216;">validation_data=validgen,</span>
<span style="color: #73d216;">#     </span><span style="color: #73d216;">verbose=2,</span>
<span style="color: #73d216;">#           </span><span style="color: #73d216;">nb_val_samples=theta.valid_samples_per_epoch)</span>
<span style="color: #73d216;"># </span><span style="color: #73d216;">model.save_weights("model.h5")</span>
<span style="color: #73d216;"># </span><span style="color: #73d216;">with open("model.json", "w") as f:</span>
<span style="color: #73d216;">#     </span><span style="color: #73d216;">f.write(model.to_json())</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: <span class="timestamp-wrapper"><span class="timestamp">&lt;2017-01-19&gt;</span></span></p>
<p class="author">Author: David A. Ventimiglia</p>
<p class="date">Created: 2017-01-19 Thu 10:54</p>
<p class="creator">Emacs 24.5.1 (Org mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
